{% extends 'base.html' %}
{% load humanize %}
{% block title %}POS - Residence256{% endblock %}
{% block header_class %}pos-header{% endblock %}
{% block extra_head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
<style>
    body {
        background-color: #f4f4f9;
        font-family: 'Arial', sans-serif;
        margin: 0;
    }
    .pos-header {
        background-color: #d4edda;
        background-image: url('/static/flower.jpeg');
        background-repeat: repeat;
        background-size: 80px;
        background-position: top left;
        color: black;
        padding: 1rem;
        text-align: center;
    }
    .table-card {
        cursor: pointer;
        transition: transform 0.2s;
        white-space: nowrap;
        font-size: 0.9rem;
        padding: 10px;
    }
    .table-card:hover {
        transform: scale(1.05);
    }
    .table-card.available {
        background-color: #d4edda;
    }
    .table-card.occupied {
        background-color: #f8d7da;
    }
    .menu-item {
        cursor: pointer;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 12px;
        text-align: center;
        transition: background-color 0.2s;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 0.95rem;
        white-space: normal;
        word-break: break-word;
        overflow: hidden;
    }
    .menu-item:hover {
        background-color: #f8f9fa;
    }
    .order-summary {
        background-color: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        height: 100%;
    }
    .category-nav .nav-link {
        font-weight: bold;
        background-color: #007BFF;
        color: white;
    }
    .category-nav .nav-link.active {
        background-color: #0056b3;
        color: white;
    }
    .full-height {
        min-height: calc(100vh - 120px);
    }
    .table-room-section {
        max-height: 80vh;
        overflow-y: auto;
    }
    .order-table th, .order-table td {
        font-size: 0.9rem;
        padding: 10px;
        text-align: center;
    }
    .zero-price {
        color: red;
        font-weight: bold;
    }
</style>
{% endblock %}
{% block content %}
<div class="row h-100">
    <div class="col-md-3">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Table/Room Management</h5>
            </div>
            <div class="card-body table-room-section">
                <div class="row">
                    {% for table in tables %}
                    <div class="col-12 mb-2">
                        <div class="table-card card text-center {% if table.is_occupied %}occupied{% else %}available{% endif %}" 
                             data-status="{% if table.is_occupied %}occupied{% else %}available{% endif %}" 
                             data-id="{{ table.name }}"
                             data-table-id="{{ table.id }}"
                             onclick="handleTableClick('{{ table.name }}', {{ table.id }})"
                             ondblclick="handleTableDoubleClick('{{ table.name }}', {{ table.id }})">
                            <h6>{{ table.name }}</h6>
                            <p class="mb-0 status-text">{% if table.is_occupied %}Occupied{% else %}Available{% endif %}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-5">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Menu Items</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs category-nav mb-3">
                    <li class="nav-item">
                        <a class="nav-link active" href="#starters" data-bs-toggle="tab">Starters</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#main-course" data-bs-toggle="tab">Main Course</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#desserts" data-bs-toggle="tab">Desserts</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="starters">
                        <div class="row">
                            {% for item in menu_items %}
                            {% if item.category == 'Starters' %}
                            <div class="col-4 mb-3">
                                <div class="menu-item" onclick="addToOrder('{{ item.name }}', {{ item.price|floatformat:2 }})">
                                    <span>{{ item.name }}</span>
                                    <br>
                                    <span class="{% if item.price <= 0 %}zero-price{% endif %}">
                                        UGX {{ item.price|floatformat:2|intcomma }}
                                    </span>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <div class="tab-pane fade" id="main-course">
                        <div class="row">
                            {% for item in menu_items %}
                            {% if item.category == 'Main Course' %}
                            <div class="col-4 mb-3">
                                <div class="menu-item" onclick="addToOrder('{{ item.name }}', {{ item.price|floatformat:2 }})">
                                    <span>{{ item.name }}</span>
                                    <br>
                                    <span class="{% if item.price <= 0 %}zero-price{% endif %}">
                                        UGX {{ item.price|floatformat:2|intcomma }}
                                    </span>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <div class="tab-pane fade" id="desserts">
                        <div class="row">
                            {% for item in menu_items %}
                            {% if item.category == 'Desserts' %}
                            <div class="col-4 mb-3">
                                <div class="menu-item" onclick="addToOrder('{{ item.name }}', {{ item.price|floatformat:2 }})">
                                    <span>{{ item.name }}</span>
                                    <br>
                                    <span class="{% if item.price <= 0 %}zero-price{% endif %}">
                                        UGX {{ item.price|floatformat:2|intcomma }}
                                    </span>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="order-summary card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Order Summary (Table: <span id="selected-table">Select Table/Room</span>)</h5>
            </div>
            <div class="card-body">
                <form id="order-form" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="customer" value="Guest">
                    <input type="hidden" name="table" id="id_table">
                    <input type="hidden" name="order_items" id="order-items">
                    <table class="table table-bordered order-table">
                        <thead>
                            <tr>
                                <th>SNo</th>
                                <th>Item</th>
                                <th>Qty</th>
                                <th>Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="order-list"></tbody>
                    </table>
                    <hr>
                    <h6>Total: UGX <span id="order-total">0</span></h6>
                    <div class="mt-3">
                        <button type="submit" name="submit-order" class="btn btn-success w-100 mb-2" onclick="submitOrder()">Submit Order</button>
                        <button type="button" class="btn btn-info w-100 mb-2" onclick="printReceipt()">Print Receipt</button>
                        <button type="button" class="btn btn-danger w-100" onclick="clearOrder()">Clear Order</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="tableModal" tabindex="-1" aria-labelledby="tableModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tableModalLabel">Select Table or Room</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Please select a table or room to start the order.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_scripts %}
<script>
    let orderItems = [];
    let total = 0;
    let selectedTable = null;
    let selectedTableId = null;

    function showTableModal() {
        const modal = new bootstrap.Modal(document.getElementById('tableModal'), {
            backdrop: 'static',
            keyboard: false
        });
        modal.show();
    }

    function updateTableUI(tableName, isOccupied) {
        const tableCard = document.querySelector(`.table-card[data-id="${tableName}"]`);
        if (tableCard) {
            tableCard.classList.remove('available', 'occupied');
            tableCard.classList.add(isOccupied ? 'occupied' : 'available');
            tableCard.setAttribute('data-status', isOccupied ? 'occupied' : 'available');
            const statusText = tableCard.querySelector('.status-text');
            statusText.textContent = isOccupied ? 'Occupied' : 'Available';
        }
    }

    function handleTableClick(tableName, tableId) {
        console.log(`handleTableClick: tableName=${tableName}, tableId=${tableId}`);
        fetch('{% url "update_table_status" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams({
                table_id: tableId,
                is_occupied: 'true'
            })
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.status === 'success') {
                updateTableUI(tableName, true);
                selectedTable = tableName;
                selectedTableId = tableId;
                document.getElementById('selected-table').textContent = tableName;
                document.getElementById('id_table').value = tableId;
                bootstrap.Modal.getInstance(document.getElementById('tableModal'))?.hide();
            } else {
                alert(`Failed to update table status for ${tableName}: ${data.message || 'Unknown error'}`);
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert(`Network error updating table status for ${tableName}: ${error.message}`);
        });
    }

    function handleTableDoubleClick(tableName, tableId) {
        if (selectedTable === tableName) {
            console.log(`handleTableDoubleClick: tableName=${tableName}, tableId=${tableId}`);
            fetch('{% url "update_table_status" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    table_id: tableId,
                    is_occupied: 'false'
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.status === 'success') {
                    updateTableUI(tableName, false);
                    selectedTable = null;
                    selectedTableId = null;
                    document.getElementById('selected-table').textContent = 'Select Table/Room';
                    document.getElementById('id_table').value = '';
                    orderItems = [];
                    updateOrderSummary();
                } else {
                    alert(`Failed to free table ${tableName}: ${data.message || 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert(`Network error freeing table ${tableName}: ${error.message}`);
            });
        }
    }

    function addToOrder(itemName, price) {
        if (!selectedTable) {
            showTableModal();
            alert('Please select a table or room first!');
            return;
        }
        if (price <= 0) {
            alert(`Cannot add ${itemName} to order: Price is invalid (UGX ${price.toFixed(2)}).`);
            return;
        }
        const existingItem = orderItems.find(item => item.name === itemName);
        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            orderItems.push({ name: itemName, price: parseFloat(price), quantity: 1 });
        }
        updateOrderSummary();
    }

    function updateOrderSummary() {
        const orderList = document.getElementById('order-list');
        orderList.innerHTML = '';
        total = 0;
        orderItems.forEach((item, index) => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${item.name}</td>
                <td>${item.quantity}</td>
                <td>UGX ${item.price.toLocaleString('en-UG', { minimumFractionDigits: 2 })}</td>
                <td>UGX ${itemTotal.toLocaleString('en-UG', { minimumFractionDigits: 2 })}</td>
            `;
            orderList.appendChild(row);
        });
        document.getElementById('order-total').textContent = total.toLocaleString('en-UG', { minimumFractionDigits: 2 });
        document.getElementById('order-items').value = JSON.stringify(orderItems);
    }

    function submitOrder() {
        if (!selectedTable) {
            showTableModal();
            alert('Please select a table or room first!');
            event.preventDefault();
            return;
        }
        if (orderItems.length === 0) {
            alert('No items in the order!');
            event.preventDefault();
            return;
        }
    }

    function printReceipt() {
        if (!selectedTable || orderItems.length === 0) {
            alert('No items to print in receipt!');
            return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text('Residence256 Hotel', 10, 10);
        doc.setFontSize(12);
        doc.text('Plot 256, Kampala, Uganda', 10, 20);
        doc.text(`Table: ${selectedTable}`, 10, 30);
        doc.text(`Date: ${new Date().toLocaleString('en-UG', { timeZone: 'Africa/Nairobi' })}`, 10, 40);
        doc.autoTable({
            startY: 50,
            head: [['SNo', 'Item', 'Qty', 'Price', 'Total']],
            body: orderItems.map((item, index) => [
                index + 1,
                item.name,
                item.quantity,
                `UGX ${item.price.toLocaleString('en-UG', { minimumFractionDigits: 2 })}`,
                `UGX ${(item.quantity * item.price).toLocaleString('en-UG', { minimumFractionDigits: 2 })}`
            ]),
            styles: { fontSize: 10 },
            columnStyles: {
                0: { cellWidth: 15 },
                1: { cellWidth: 80 },
                2: { cellWidth: 20 },
                3: { cellWidth: 35 },
                4: { cellWidth: 40 }
            }
        });
        const finalY = doc.lastAutoTable.finalY;
        doc.text(`Total: UGX ${total.toLocaleString('en-UG', { minimumFractionDigits: 2 })}`, 10, finalY + 10);
        doc.save(`Receipt_${selectedTable}_${new Date().getTime()}.pdf`);
    }

    function clearOrder() {
        if (selectedTable) {
            console.log(`clearOrder: tableName=${selectedTable}, tableId=${selectedTableId}`);
            fetch('{% url "update_table_status" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: new URLSearchParams({
                    table_id: selectedTableId,
                    is_occupied: 'false'
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.status === 'success') {
                    updateTableUI(selectedTable, false);
                } else {
                    alert(`Failed to clear table ${selectedTable}: ${data.message || 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert(`Network error clearing table ${selectedTable}: ${error.message}`);
            });
        }
        orderItems = [];
        selectedTable = null;
        selectedTableId = null;
        document.getElementById('selected-table').textContent = 'Select Table/Room';
        document.getElementById('id_table').value = '';
        updateOrderSummary();
    }
</script>
{% endblock %}