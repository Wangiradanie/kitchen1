{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block title %}Dashboard - Residence256 Hotel{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>

<style>
    .kpi-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transition: transform .2s;
    }
    .kpi-card:hover { transform: translateY(-5px); }
    .kpi-card.revenue { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
    .kpi-card.orders  { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .kpi-card.expense { background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%); }
    .kpi-card.profit  { background: linear-gradient(135deg, #9c27b0 0%, #e91e63 100%); }

    .chart-container { position:relative; height:380px; background:#fff; border-radius:12px; padding:1rem; box-shadow:0 2px 8px rgba(0,0,0,.05); }
    .year-selector { margin:.5rem 0; }
    .card-header { border-radius:12px 12px 0 0 !important; font-weight:600; }
    .chart-title { font-size:1.1rem; font-weight:600; margin-bottom:.5rem; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-6 fw-bold text-primary">Restaurant Dashboard</h1>
            <p class="text-muted">Current: <strong>{{ current_month }} {{ current_year }}</strong></p>
        </div>
    </div>

    <!-- ==== KPIs ==== -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="kpi-card revenue">
                <h2 class="mb-1">UGX {{ current_revenue|floatformat:2|intcomma }}</h2>
                <p class="mb-0 fw-bold">Revenue</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-card orders">
                <h2 class="mb-1">{{ current_orders|intcomma }}</h2>
                <p class="mb-0 fw-bold">Orders</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-card expense">
                <h2 class="mb-1">UGX {{ current_expense|floatformat:2|intcomma }}</h2>
                <p class="mb-0 fw-bold">Expenses</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="kpi-card profit">
                <h2 class="mb-1">UGX {{ current_profit|floatformat:2|intcomma }}</h2>
                <p class="mb-0 fw-bold">Profit</p>
            </div>
        </div>
    </div>

    <!-- ==== Charts ==== -->
    <div class="row g-4 mb-5">
        <!-- Revenue -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <div class="chart-title">Revenue Trend</div>
                </div>
                <div class="card-body p-3">
                    <div class="year-selector">
                        <select id="revenueYear" class="form-select form-select-sm"></select>
                    </div>
                    <div class="chart-container"><canvas id="revenueChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Orders -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <div class="chart-title">Orders Trend</div>
                </div>
                <div class="card-body p-3">
                    <div class="year-selector">
                        <select id="ordersYear" class="form-select form-select-sm"></select>
                    </div>
                    <div class="chart-container"><canvas id="ordersChart"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Expense -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <div class="chart-title">Expense Trend</div>
                </div>
                <div class="card-body p-3">
                    <div class="year-selector">
                        <select id="expenseYear" class="form-select form-select-sm"></select>
                    </div>
                    <div class="chart-container"><canvas id="expenseChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==== Top 5 Menu Items ==== -->
    <div class="card">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Top 5 Menu Items ({{ current_year }})</h5>
        </div>
        <div class="card-body">
            <ol class="list-group list-group-numbered">
                {% for item in top_items %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span><strong>{{ item.name }}</strong></span>
                    <span class="badge bg-primary rounded-pill">
                        {{ item.quantity }} Ã— UGX {{ item.sales|floatformat:2|intcomma }}
                    </span>
                </li>
                {% empty %}
                <li class="list-group-item">No sales data yet.</li>
                {% endfor %}
            </ol>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const data = {
        current_year: {{ current_year|safe }},
        years: {{ years|safe }},
        revenue: {{ revenue_data|safe }},
        orders: {{ orders_data|safe }},
        expense: {{ expense_data|safe }}
    };

    // ---- Year selectors ----
    ['revenueYear','ordersYear','expenseYear'].forEach(id => {
        const sel = document.getElementById(id);
        data.years.forEach(y => {
            const opt = new Option(y, y, y == data.current_year, y == data.current_year);
            sel.add(opt);
        });
    });

    // ---- Chart config (UGX in tooltip) ----
    const cfg = {
        type: 'line',
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode:'index', intersect:false },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: ctx => {
                            let l = ctx.dataset.label || '';
                            if (l) l += ': ';
                            if (ctx.parsed.y !== null) {
                                const money = ctx.dataset.label.includes('Revenue') ||
                                              ctx.dataset.label.includes('Expense');
                                const fmt = ctx.parsed.y.toLocaleString('en-US',{
                                    minimumFractionDigits:2,
                                    maximumFractionDigits:2
                                });
                                l += money ? `UGX ${fmt}` : fmt;
                            }
                            return l;
                        }
                    }
                },
                legend: { position:'top' },
                zoom: { zoom:{wheel:{enabled:true},pinch:{enabled:true},mode:'x'},
                        pan:{enabled:true,mode:'x'} }
            },
            scales: { y:{beginAtZero:true}, x:{grid:{display:false}} }
        }
    };

    const create = (ctx, year, d, label, col) => new Chart(ctx, {
        ...cfg,
        data: {
            labels:['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
            datasets:[{
                label:label,
                data:d[year],
                borderColor:col,
                backgroundColor:col.replace('1)','0.2)'),
                tension:0.3,
                fill:true,
                pointRadius:4,
                pointHoverRadius:6,
                borderWidth:3
            }]
        }
    });

    const revenueChart = create(document.getElementById('revenueChart'), data.current_year, data.revenue, 'Revenue (UGX)', 'rgb(75,192,75)');
    const ordersChart  = create(document.getElementById('ordersChart'),  data.current_year, data.orders,  'Orders',        'rgb(54,162,235)');
    const expenseChart = create(document.getElementById('expenseChart'), data.current_year, data.expense, 'Expense (UGX)', 'rgb(255,99,132)');

    const update = (chart, year, d) => { chart.data.datasets[0].data = d[year]; chart.update('active'); };
    document.getElementById('revenueYear').addEventListener('change', e=>update(revenueChart,e.target.value,data.revenue));
    document.getElementById('ordersYear').addEventListener('change',  e=>update(ordersChart, e.target.value,data.orders));
    document.getElementById('expenseYear').addEventListener('change', e=>update(expenseChart,e.target.value,data.expense));
</script>
{% endblock %}