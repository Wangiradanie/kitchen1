{% extends 'base.html' %}
{% load humanize %}
{% block title %}Recipes{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5>Recipes</h5>
        </div>
        <div class="card-body">
            <form method="post" class="mb-4">
                {% csrf_token %}
                <input type="hidden" name="add_recipe">
                <div class="row g-3">
                    <div class="col-md-3">{{ form.name }}</div>
                    <div class="col-md-3">{{ form.category }}</div>
                    <div class="col-md-2">{{ form.profit_percentage }}</div>
                    <div class="col-md-2"><button type="button" onclick="addIngredient()" class="btn btn-sm btn-outline-primary">+ Ingredient</button></div>
                    <div class="col-md-2"><button type="submit" class="btn btn-success">Save Recipe</button></div>
                </div>
                <div id="ingredients"></div>
            </form>

            <div class="row">
                {% for r in recipes %}
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6>{{ r.name }} <span class="badge bg-info">{{ r.category }}</span></h6>
                            <p><strong>Cost:</strong> {{ r.total_cost|floatformat:2|intcomma }}<br>
                               <strong>Price:</strong> {{ r.selling_price|floatformat:2|intcomma }}</p>
                            <ul>
                                {% for ing in r.ingredients.all %}
                                <li>{{ ing.quantity }} {{ ing.inventory_item.units }} {{ ing.inventory_item.name }} @ {{ ing.unit_price }}</li>
                                {% endfor %}
                            </ul>
                            <form method="post" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="delete_recipe" value="{{ r.id }}">
                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
let items = {{ inventory_items|safe }};
function addIngredient() {
    let div = document.createElement('div');
    div.className = 'row g-3 mt-2';
    div.innerHTML = `
        <div class="col-md-5">
            <select name="inventory_item[]" class="form-control">
                ${items.map(i => `<option value="${i.id}">${i.name} (${i.quantity} ${i.units})</option>`).join('')}
            </select>
        </div>
        <div class="col-md-3"><input type="number" step="0.01" name="quantity[]" class="form-control" required></div>
        <div class="col-md-2"><button type="button" onclick="this.parentElement.parentElement.remove()" class="btn btn-sm btn-danger">Remove</button></div>
    `;
    document.getElementById('ingredients').appendChild(div);
}
</script>
{% endblock %}